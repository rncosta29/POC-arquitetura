%%-----------------------------------------------------------
%% Diagrama de Containers ‚Äî POC Solu√ß√µes EV-Costa (compat√≠vel com GitHub)
%%-----------------------------------------------------------

flowchart TD
    %% --- Agrupamento principal ---
    subgraph Cloud["‚òÅÔ∏è Solu√ß√µes EV-Costa Cloud Environment"]
        
        subgraph Mobile["üì± Aplicativo M√≥vel (Android/iOS)"]
            A["Kotlin / SwiftUI\nInterface do usu√°rio para login, rotas EV, sess√µes de recarga e pagamentos"]
        end

        subgraph Gateway["üåê API Gateway / Ingress"]
            B["Kong / NGINX\nPonto de entrada √∫nico com autentica√ß√£o OIDC, TLS e rate-limiting"]
        end

        subgraph Services["üß© Microservices ‚Äî Spring Boot (Java 21)"]
            C["üîê Auth Service\nGerencia autentica√ß√£o e emiss√£o de tokens JWT via OIDC"]
            D["üë§ User/Profile Service\nGerencia perfis e prefer√™ncias do usu√°rio"]
            E["üó∫Ô∏è Routing Service\nCalcula rotas otimizadas considerando autonomia e pontos de recarga"]
            F["‚ö° Charging Service\nGerencia sess√µes de recarga e eventos Kafka"]
            G["üí≥ Payment Service\nTokeniza e simula pagamentos, integra com gateways mockados"]
            H["üåç Integrations Adapter\nAbstrai APIs externas (DSA-X, Shell Recharge, Premmia)"]
        end

        subgraph Infra["üß± Infraestrutura e Observabilidade"]
            I["üóÑÔ∏è PostgreSQL\nBanco Relacional de dados transacionais"]
            J["üß† Redis\nCache de sess√µes e dados tempor√°rios"]
            K["ü™∂ Kafka Broker\nMensageria distribu√≠da para eventos de recarga e faturamento"]
            L["üìä Stack de Observabilidade\nOpenTelemetry + Prometheus + Grafana + Loki + Jaeger"]
        end

    end

    %% --- Rela√ß√µes REST (azul) ---
    A -->|REST + HTTPS (OIDC Tokens)| B
    B -->|Autentica√ß√£o / Refresh Tokens| C
    B -->|User Profile| D
    B -->|Consulta de Rota EV| E
    B -->|Sess√£o de Recarga| F
    B -->|Transa√ß√£o Simulada| G

    %% --- Rela√ß√µes com bancos e cache ---
    C -->|Leitura/Escrita| I
    D -->|Leitura/Escrita| I
    F -->|Registro de Sess√µes| I
    G -->|Leitura/Escrita| I
    E -->|Cache de POIs e rotas| J
    B -->|M√©tricas e Logs| L

    %% --- Rela√ß√µes Kafka (verde) ---
    F -.->|Eventos de Sess√£o (start/stop/status)| K
    G -.->|Eventos de Fatura| K
    H -.->|Eventos de Integra√ß√£o| K
